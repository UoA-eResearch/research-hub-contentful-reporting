# ResearchHub Contentful Report

This is an AWS lambda function written in `typescript` and managed by serverless framework. Its purpose is to generate reports on the content stored in the Contentful CMS backend for the [ResearchHub](https://github.com/UoA-eResearch/hub-stack). The lambda queries the Contentful GraphQL API and stores the report data in Google Sheets and AWS S3 buckets.

## Prerequisites

This lambda function needs a token for access to the University of Auckland AWS test account. <!--add proper information here-->

## Installation

```npm install```

## Generate Typescript types

This happens automatically when you run `npm install`, but it can also be triggered manually.

```npm run generate```

## Run lambda locally

We're using the serverless framework to build and deploy the lambda function. Run
```bash
sls offline [--stage <dev | nonProd>]
```
to run the lambda function locally. This should set up an endpoint accepting POST requests under `http://localhost:3000/dev/` to trigger execution. The endpoint requires and API key, which can be disabled by setting `private: false` in `serverless.yml`.

## Deploy to AWS

```bash
sls deploy [--stage <dev | nonProd>]
```

## General structure

The root folder contains the main module `contentfulReport.ts`. It exports one `async` function which is the entry point for the AWS lambda caller and its only purpose is to run reports and handle error messages. Reports are called from this function in sequence:

```typescript
export async function contentful(): Promise<APIGatewayProxyResult> {
    try {
        await runContentOverview();
        await runPagesPerCategory();
        await runPagesPerOrgUnit();
        // ...
    }
    catch {
    // ...
    }
}
```

Reports themselves are implemented in separate modules living in the `/reports` directory. Each report should be contained in its own module.
### Structure of reporting modules

There is no limitation on how the reporting modules should be laid out. However, they should export one `async` function that can be called by the `contentfulReport.ts` module.

### Environments

1. `dev`:
    * default environment
    * connects to Contentful `dev` environment
    * connects to `data-over-time-dev` and `content-overview-dev` Google sheets
    * connects to `researchhub-contentful-backup-dev` S3 bucket
2. `nonProd`:
    * 'production' environment (called nonProd as we always deploy to AWS nonProd)
    * connects to Contentful `prod` environment
    * connects to `data-over-time` and `content-overview` Google sheets
    * connects to `researchhub-contentful-backup-test` S3 bucket
### Helper modules

#### Module `apolloClient.ts`

This helper allows opening a connection to the Contentful GraphQL server using an Apollo client. It grabs a token from AWS parameter store and connects to the environment specified in the relevant environment file. Connecting to a different environment is possible by including the environment in the `CONTENTFUL_SPACE_ENV` variable, for example:

```json
"CONTENTFUL_SPACE_ENV": "test",
```

in `/env/*.json`

#### Module `googleDocsWrapper.ts`

This is a helper for easier access to the relevant Google Docs, which store the current report information. There are 2 documents and their id's are defined environment variables in `/env`. The `googleDocsWrapper.ts` module assists with saving the data generated by the reporting modules in those 2 docs.

For both docs, there are union type definitions that contain the sheets on each of the docs. These are `CurrentReportWorkSheet` and `DataOverTimeWorkSheet` and they contain the titles of the sheets in each doc. This is because the individual sheets are reference by name instead their id to make it easier to set up the document in case a worksheets gets deleted by accident. When a new sheet is added to one of the docs the name should be added to the corresponding union type.

#### Module `csvUpload.ts`

This module helps uploading `.csv` versions of the report tables to the S3 bucket configured in `BUCKET_NAME` in the environment file.

## How to create a new report

Each report should map onto one worksheet in the Google docs. Add the worksheet first and then change the code. After adding the worksheet, the name should be added to the union types `CurrentReportWorkSheet` and/or `DataOverTimeWorkSheet` in the `googleDocsWrapper.ts` module.

The GraphQL query should be added to a new file in `/reports/queries`.

A new module should be created in the `/reports` folder. This module should handle every operation necessary for the completion of the report. This includes the GraphQL query, data processing, writing the data to the Google docs and uploading csv's to S3.