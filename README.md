# Research Hub Contentful Report

This is an AWS lambda function written in typescript. It's purpose is to generate reporting on the content stored in the contentful CMS for the research-hub. The lambda queries the contentful graphQL API and stores the report data in Google Sheets.

## Prerequisites

This lambda function needs a token for access to the University of Auckland AWS test account. <!--add proper information here-->

## Installation

```npm install```

## Generate Typescript types

This happens automatically when you run `npm install`, but it can also be triggered manually.

1. Run `npm run generate`

## How to create a new report

### General structure of reporting lambda

The root folder contains the main module `contentfulReport.ts`. It exports one `async` function which is the entry point for the AWS lambda caller and it's only purpose is to run reports and handle error messages. Reports are called from this function in sequence:

```typescript
export async function contentful(): Promise<APIGatewayProxyResult> {
    try {
        await runContentOverview();
        await runPagesPerCategory();
        await runPagesPerOrgUnit();
        // ...
    }
    catch {
    // ...
    }
}
```

Reports themselves are implemented in separate modules living in the `/reports` directory. A new ES module should be created for a new report in the same location.

### Structure of reporting modules

There is no limitation on how the reporting modules should be layed out. However, they should export one `async` function that can be called by the `contentfulReport.ts` module.

### Helper modules

#### Module `apolloClient.ts`

This helper allows opening a connection to the Contentful GraphQL server using an Apollo client. It grabs a token from AWS parameter store and connects to the master environment. Connecting to a different environment is possible by includeing the environment in the `CONTENTFUL_GRAPHQL_URI` variable, for example

```
https://graphql.contentful.com/content/v1/spaces/environments/test/${process.env.CONTENTFUL_SPACE_ID}
```

for the test environment.

#### Module `googleDocsWrapper.ts`

This is a helper for easier access to the relevant Google Docs, which store the current report information. There are 2 documents and their id's are defined in `googleDocsConfig.json`. The `googleDocsWrapper.ts` module assists with saving the data generated by the reporting modules in those 2 docs.

For both docs, there are type definitions that contain the sheets on each of the docs. These are `CurrentReportWorkSheet` and `DataOverTimeWorkSheet` and they contain the titles of the sheets in each doc. When a new sheet is added to the doc the name should be added to the corresponding union type. The sheets are selected by names and not id's because it simplifies recovering from accidental deletion of a sheet.

The base class `GoogleDoc` connects the lambda instance to the Google Docs api. For each Google doc there should be one child class inheriting from the parent class, ideally implemented with a singleton pattern.